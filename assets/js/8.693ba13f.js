(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{452:function(t,a,s){"use strict";s.r(a);var e=s(1),n=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("React的理念其实就是实现“快速响应”。\n")]),t._v(" "),a("h1",{attrs:{id:"react-理念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#react-理念"}},[t._v("#")]),t._v(" React 理念")]),t._v(" "),a("p",[t._v("最近准备开始学习 React 源码了，在学习 react 源码之前，首先了解了一下 React 的理念，引用官方的话是这样的：")]),t._v(" "),a("blockquote",[a("p",[t._v("我们认为，React 是用 JavaScript 构建"),a("strong",[t._v("快速响应")]),t._v("的大型 Web 应用程序的首选方式。它在 Facebook 和 Instagram 上表现优秀。")])]),t._v(" "),a("p",[t._v("正如官方理念所说，关键是实现"),a("code",[t._v("快速响应")]),t._v("，那么如何去实现快速响应呢？")]),t._v(" "),a("p",[t._v("在我们日常生活中，会导致"),a("code",[t._v("快速响应")]),t._v("不能良好实现的有两种情况：")]),t._v(" "),a("ul",[a("li",[t._v("页面或应用需要大量的操作与计算；")]),t._v(" "),a("li",[t._v("发送网络请求后，需要等待响应结果导致不能快速响应。")])]),t._v(" "),a("p",[t._v("这两类情况出现的根本原因又可以归结于这两类情况：")]),t._v(" "),a("ul",[a("li",[t._v("CPU 限制；")]),t._v(" "),a("li",[t._v("IO（网络延迟）。")])]),t._v(" "),a("p",[t._v("下面我们从这两个方面来看看 React 是怎么做的。")]),t._v(" "),a("h2",{attrs:{id:"cpu-问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cpu-问题"}},[t._v("#")]),t._v(" CPU 问题")]),t._v(" "),a("h5",{attrs:{id:"复现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#复现"}},[t._v("#")]),t._v(" 复现")]),t._v(" "),a("p",[t._v("我们先看看下面这个 demo：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("App")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" len "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ul"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Array")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("len"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fill")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" i")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("li"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("li"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("ul"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" rootEl "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("querySelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"#root"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nReactDOM"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("App "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rootEl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("这个 demo 向浏览器视图中渲染了 3000 个"),a("code",[t._v("li")]),t._v("，并且是通过 JS 来实现的，我们知道，JS 可以操作 DOM，但是"),a("code",[t._v("GUI渲染线程")]),t._v("与"),a("code",[t._v("JS线程")]),t._v("是互斥的。所以"),a("strong",[t._v("JS 脚本执行")]),t._v("和"),a("strong",[t._v("浏览器布局、绘制")]),t._v("（GUI 线程）不能同时执行。")]),t._v(" "),a("p",[t._v("那么如果 JS 线程执行时间过长，会导致什么呢？GUi 无法进行"),a("strong",[t._v("浏览器的布局和绘制")]),t._v("。")]),t._v(" "),a("h5",{attrs:{id:"解决"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决"}},[t._v("#")]),t._v(" 解决")]),t._v(" "),a("p",[a("code",[t._v("React")]),t._v("是如何解决这一问题的呢？")]),t._v(" "),a("p",[t._v("答案是：在浏览器每一帧加载的时间中，预留一些时间给 JS 线程，"),a("code",[t._v("React")]),t._v("利用这部分时间更新组件（在 React"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/scheduler/src/forks/SchedulerHostConfig.default.js#L119",target:"_blank",rel:"noopener noreferrer"}},[t._v("源码 (opens new window)"),a("OutboundLink")],1),t._v("中，预留的初始时间是 5ms）。")]),t._v(" "),a("p",[t._v("当预留的时间不够用时，"),a("code",[t._v("React")]),t._v("将线程控制权交还给 GUI 使其有时间渲染 UI，"),a("code",[t._v("React")]),t._v("则等待下一帧时间到来继续被中断的工作。")]),t._v(" "),a("p",[t._v("这样的工作有一个专业术语，被称作为"),a("code",[t._v("时间切片")]),t._v("，这样 JS 的执行就会被拆分到每一帧所预留的执行时间中，而浏览器就有剩余的时间执行"),a("strong",[t._v("布局和绘制")]),t._v("。")]),t._v(" "),a("h5",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("p",[t._v("React 利用"),a("code",[t._v("时间切片")]),t._v("解决"),a("code",[t._v("CPU")]),t._v("的限制，关键解决方案则是：将 JS 的一次性更新变为了可以中断的异步更新。")]),t._v(" "),a("h2",{attrs:{id:"io-问题-网络延迟"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#io-问题-网络延迟"}},[t._v("#")]),t._v(" IO 问题（网络延迟）")]),t._v(" "),a("h5",{attrs:{id:"说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#说明"}},[t._v("#")]),t._v(" 说明")]),t._v(" "),a("p",[a("code",[t._v("网络延迟")]),t._v("的问题相信大家都会在日常中体验到，这里就不做过多的复现。简单来说就是在点击触发了某一请求事件之后需要"),a("strong",[t._v("等待网络的请求结果")]),t._v("，那么这一段时间如果"),a("strong",[t._v("过长")]),t._v("则导致了不能"),a("code",[t._v("快速响应")]),t._v("。")]),t._v(" "),a("p",[t._v("我们直接来看 React 是如何解决这一问题的。")]),t._v(" "),a("h5",{attrs:{id:"解决-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决-2"}},[t._v("#")]),t._v(" 解决")]),t._v(" "),a("p",[t._v("在点击某一按钮触发事件之后，先在当前页面停留一小段时间，这一小段时间用来"),a("strong",[t._v("请求数据")]),t._v("。如果这一时间足够短，用户基本不会感知得到。如果请求时间超过了某一个范围，再去展示"),a("code",[t._v("loading")]),t._v("的效果。")]),t._v(" "),a("p",[t._v("如果我们一点击就展示"),a("code",[t._v("loading")]),t._v(" ，那么即便时间很短，也会让用户感知到。")]),t._v(" "),a("p",[t._v("React 源码参考"),a("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/concurrent-mode-suspense.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Suspense (opens new window)"),a("OutboundLink")],1),t._v("功能及配套的"),a("code",[t._v("hook")]),t._v("——"),a("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/concurrent-mode-reference.html#usedeferredvalue",target:"_blank",rel:"noopener noreferrer"}},[t._v("useDeferredValue (opens new window)"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("h5",{attrs:{id:"总结-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结-2"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("p",[t._v("实际上，在源码内部为了支持这些特性，同样也是将"),a("strong",[t._v("同步的更新变为了可中断的异步更新")]),t._v("。")])])}),[],!1,null,null,null);a.default=n.exports}}]);